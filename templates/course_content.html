{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Software Construction & Evolution | E-Learning Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'course/style.css' %}">
    <link rel="icon" type="image/x-icon" href="{% static 'assets/images/logo/favicon.png' %}">
</head>

<body>

    {% block content %}
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="profile-info" style="text-align: center; margin-bottom: 20px;">
                <img src="{% static 'assets/images/user-icon.png' %}" alt=""
                    style="width: 250px; height: 250px; border-radius: 50%; background: white; padding: 10px;">

                <h2 style="color: #ffffff; margin-top: 10px;">
                    {% if request.user.first_name or request.user.last_name %}
                    {{ request.user.first_name }} {% if request.user.last_name %}{{ request.user.last_name }}{% endif %}
                    {% else %}
                    {{ request.user.username }}
                    {% endif %}
                </h2>
                <p style="color: #ffffff;">Student</p>

                <div style="text-align: left; margin-left: 20px;">
                    <h3 style="color: #ffffff;">Topic Progress: {{ topic_progress }}%</h3>
                    <h3 style="color: #ffffff;">Completed Topics: {{ completed_topics }}/{{ total_topics }}</h3>
                    <h3 style="color: #ffffff;">Quiz Progress: {{ quiz_progress }}%</h3>
                    <h3 style="color: #ffffff;">Completed Quizzes: {{ completed_quizzes }}/{{ total_quizzes }}</h3>
                </div>
            </div>

            <h2 style="text-align: center; color: #ffffff; margin-bottom: 20px;">COURSE CHAPTERS</h2>
            <h2></h2>

            <div class="chapters">
                {% for chapter in course.chapters.all %}
                <div class="chapter-item">
                    <div class="chapter-header {% if chapter.id == current_topic.chapter.id %}active{% endif %}">
                        <span>{{ chapter.title|upper }}</span>
                        <i
                            class="fas {% if chapter.id == current_topic.chapter.id %}fa-chevron-down{% else %}fa-chevron-right{% endif %}"></i>
                    </div>

                    <div class="topics {% if chapter.id == current_topic.chapter.id %}show{% endif %}">
                        {% for topic in chapter.topics.all %}
                        <div class="topic-item {% if topic.id == current_topic.id %}active{% endif %} "
                            onclick="window.location.href='{% url 'course_topic' topic.id %}'">
                            {{ topic.title }}
                            {% if topic.id in completed_topic_ids %}
                            <span style="color: #22c55e;">✅</span>
                            {% endif %}
                        </div>
                        {% endfor %}

                        <!-- ✅ har bir chapter oxirida chiqadigan QUIZ -->
                        <div class="topic-item" onclick="window.location.href='{% url 'quiz_view' chapter.id %}'"
                            style="padding:8px 12px; cursor:pointer; font-weight:bold; background:#ff0000; text-align:center; border-radius:4px;">
                            <a style="color:white; text-decoration: none;"
                                href="{% url 'quiz_view' chapter.id %}">QUIZ</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>


        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1 style="color: #704A74;"><span style="color: #f72585;">COURSE:</span> {{ course.title }}</h1>
                <div class="user-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search...">
                    </div>
                    <div class="user-profile">
                        <div class="avatar">
                            {{ request.user.first_name|slice:":1"|upper }}
                            {% if request.user.last_name %}{{ request.user.last_name|slice:":1"|upper }}{% endif %}
                        </div>
                        <span>{{ request.user.first_name }}</span>

                    </div>
                    <!-- button to home page when mouse hover color="#f72585"-->
                    <button class="btn btn-outline home-btn" onclick="window.location.href='/'">
                        <i class="fas fa-home"></i> Home
                    </button>
                    <!-- logout button -->
                    <button class="btn btn-outline home-btn" onclick="window.location.href='{% url 'logout' %}'">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                    <style>
                        .home-btn:hover {
                            color: #f72585 !important;
                            border-color: #f72585 !important;
                        }

                        .home-btn:hover i {
                            color: #f72585 !important;
                        }
                    </style>
                </div>
            </div>


            <div class="content" id="main-content">
                {% if selected_topic %}
                <h2 style="color:#3b82f6;"><span style="color: #f72585;">#THEME:</span> {{ selected_topic.title|upper }}
                </h2>
                <p>{{ selected_topic.content|safe }}</p>
                {% else %}
                {% if first_topic %}
                <div class="content">
                    <h2>{{ first_topic.title }}</h2>
                    <p>{{ first_topic.content|safe }}</p>
                </div>
                {% endif %}
                {% endif %}
                <a href="{% url 'next_topic' selected_topic.id %}" class="btn btn-primary" style="text-decoration: none;">
                    Next Topic <i class="fas fa-arrow-right"></i>
                </a>

            </div>

            <!-- Quiz Section -->
            {% if first_chapter and first_chapter.quiz %}
            <div class="quiz-container">
                <div class="quiz-header">
                    <h3>{{ first_chapter.quiz.title }}</h3>
                    <span>Progress: 0/{{ first_chapter.quiz.questions.count }} questions</span>
                </div>

                <div class="progress-bar">
                    <div class="progress"></div>
                </div>

                {% for question in first_chapter.quiz.questions.all %}
                <div class="question">
                    <h4>{{ question.text }}</h4>

                    <div class="options">
                        {% for choice in question.choices.all %}
                        <div class="option">{{ choice.text }}</div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}

                <div class="navigation">
                    <button class="btn btn-outline">
                        <i class="fas fa-arrow-left"></i> Previous Question
                    </button>
                    <button class="btn btn-primary">
                        Next Question <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
    {% endblock %}


    <script>
        // Toggle chapter topics
        document.querySelectorAll('.chapter-header').forEach(header => {
            header.addEventListener('click', () => {
                // Toggle current chapter
                const topics = header.nextElementSibling;
                const icon = header.querySelector('i');

                // Close all other chapters
                document.querySelectorAll('.topics').forEach(t => {
                    if (t !== topics) {
                        t.classList.remove('show');
                        t.previousElementSibling.querySelector('i').className = 'fas fa-chevron-right';
                    }
                });

                // Toggle current chapter
                topics.classList.toggle('show');
                icon.className = topics.classList.contains('show') ?
                    'fas fa-chevron-down' : 'fas fa-chevron-right';
            });
        });

        // Topic selection
        document.querySelectorAll('.topic-item').forEach(topic => {
            topic.addEventListener('click', () => {
                document.querySelectorAll('.topic-item').forEach(t => {
                    t.classList.remove('active');
                });
                topic.classList.add('active');
            });
        });

        // Quiz option selection
        document.querySelectorAll('.option').forEach(option => {
            option.addEventListener('click', () => {
                // Remove selection from all options in this question
                option.parentElement.querySelectorAll('.option').forEach(opt => {
                    opt.classList.remove('selected');
                });

                // Select clicked option
                option.classList.add('selected');
            });
        });
    </script>
</body>

</html>